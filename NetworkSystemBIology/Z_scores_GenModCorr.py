##################################################
###    Computation of gene-module z-scores     ###
##################################################
#
# Since gene-module correlations for randomized modules were independent of module size we used a single module size for the randomized modules. 
# For each regulatory network, gene-module correlations for 100 randomized modules were calculated. 
# Each random correlation calculated was divided by the average of the operon correlations in that organism to avoid a bias when comparing with relative correlations. 
# The mean and standard deviation of this corrected background correlations were used to compute a z-score for each of the predicted modules.
# 
# Author: Victor E Nieto Caballero , Diego Camacho and Laura Hinojosa
# Last modification: Summer 2021

import numpy as np
import ast
import re
import itertools

#Dictionary with the mean of gen-operon correlations per organism
GenOpCor={"B_subtilis":[0.6207260842406183], "M_tuberculosis":[0.2627506658180666], "S_coelicolor":[0.2615598072512162],  "E_coli":[0.4671179663519087],  "P_aeruginosa":[0.31573649416401817]}
#Dictionary with the values of 100 gen-module random correlations per organism
GenModCorrRand={"B_subtilis":[0.00359757859795107, 0.04174897443176918, 0.015265291515996674, 0.025542919261097134, 0.020156887863306223, 0.0274061302087527, 0.02753675340184194, 0.0374731517270154, 0.015711956123766437, 0.0026765426039166785, 0.0022318791389642346, 0.025760452308407372, 0.013135257941694185, 0.03018000303590375, 0.01718267611406486, 0.02426200980005682, 0.013062319452217868, -0.012715457289760736, 0.009980865350555966, 0.015985266277928057, 0.008587522341678748, 0.01642703484874007, 0.006659742371130579, 0.020166318668467215, 0.0011031302858806912, 0.013926068726765849, 0.018394329292876745, 0.013975495900783882, 0.02302118026425645, 0.0015381893136151305, 0.015864285612762666, 0.01319741165005615, 0.023711993122014975, 0.005589271381013984, 0.016350424375326737, 0.007799745256651095, 0.019005652676070534, 0.008228055831724488, 0.025294993127217752, 0.008843706545101143, 0.029804274185100215, 0.020365685960784873, 0.0253663225879793, 0.027447253483179442, 0.019568941127621156, 0.023724556615796328, 0.02733130317219904, 0.021460765582739953, 0.03979419714054544, 0.0158955654767938, 0.021235546109168443, 0.05068540619051782, 0.03134572750701123, 0.01048552599148056, 0.010948949212416263, 0.017433350993447793, 0.009396717514114937, 0.01464181945244284, 0.014296767844600291, 0.005861567272759314, 0.016663900204608964, 0.004465425795977643, 0.0032886701342735567, 0.02628998876346729, 0.01802187885448188, 0.020233412041014455, 0.030504419329628572, -0.0014016857194892088, 0.023950285842310327, 0.038108995988649294, 0.016562106731612763, 0.012531816092552764, 0.010691033619302778, 0.016563091365390553, 0.03443253641443295, 0.036476685956737455, 0.005653572666848127, 0.007577569963774902, 0.019515695550618484, 0.03438366972537886, 0.010552667950552787, 0.023112429629957396, -0.004298104090921117, 0.006680089490028117, 0.005830450587451966, 0.004951967272505691, 0.02109621264796417, 0.011071256066608838, 0.023733284482992785, 0.008120356720880784, 0.010293973468264071, 0.016605010294743833, 0.010091646268735727, 0.023080534030396435, 0.017776572633836207, -0.0006687167479061291, 0.006449542563866973, 0.018576719773076834, 0.02573804730962239, 0.027408041515015823], "M_tuberculosis":[0.01269847801476124, 0.011201902623339522, 0.010914511803094494, 0.014139299732302473, 0.009567315113464753, 0.010123755900997941, 0.017955899106580193, 0.015327732860628012, 0.016320681074561326, 0.014248963854014564, 0.01869718670548431, 0.023372928140587973, 0.011435357423099786, 0.009233496086387698, 0.01937553731335555, 0.015725463420900133, 0.011090041039871254, 0.022615167615931676, 0.023755199183855914, 0.01319309769368499, 0.017020347370460983, 0.013112413719784957, 0.01130604531866191, 0.018867173170245458, 0.020003625762493066, 0.007733774780950922, 0.018170093218448837, 0.01322580855167662, 0.016757741373404095, 0.013666859716607591, 0.015458024926701697, 0.022097703570686945, 0.017010610511716664, 0.0163820646585748, 0.01934518880765522, 0.013799692555558097, 0.017695310892728366, 0.008589280317050044, 0.01650570926828829, 0.007740828935392004, 0.016848717926785817, 0.019126162040795286, 0.017777002580575293, 0.019830682724309035, 0.012627603808614298, 0.011147378723126546, 0.01178111739322944, 0.01323260191670032, 0.012601987632720236, 0.008028112219733832, 0.019350523854788013, 0.01210365223648447, 0.01972299686987015, 0.012859764660949386, 0.01166067581539025, 0.009033509156845553, 0.010581224249931583, 0.014452827356692287, 0.01117471607823099, 0.013178168725589589, 0.021213121719707934, 0.015647078168621927, 0.018370562854996525, 0.013042090613833733, 0.013360643055413039, 0.012150795526685645, 0.0076365920819849486, 0.018419875054695764, 0.017460234035070625, 0.017545139887215885, 0.017877695229393496, 0.011405086442579124, 0.0156376636898874, 0.012395811268744516, 0.014229797698935266, 0.01254067272128568, 0.011068231182601564, 0.013070160135653397, 0.008929804800367402, 0.015679049355868512, 0.01012160287481438, 0.019490794629783793, 0.012148388548271443, 0.012913947332669406, 0.01568079449461457, 0.013397372371422777, 0.015848681120096776, 0.019604826742738116, 0.016641525011290882, 0.02002796073583373, 0.01461132435848094, 0.01194016829831676, 0.019572264399151315, 0.01499060479071451, 0.009310341742743594, 0.012549777216548964, 0.009238376252571236, 0.022384841627079825, 0.02014439861453756, 0.015404919380371267], "S_coelicolor":[0.007130030859226454, 0.030540320486461995, 0.0055668750355170275, 0.017236307896489323, -0.0076365344526590166, -0.007729860240208616, -0.004111596857104763, 0.016153582682261622, 0.009880772028758198, -0.00995030594974261, 0.00676846007002315, 0.007196119755131236, 0.007826979508190852, 0.007615175831242781, 0.009501684010770887, 0.01869942973612231, 0.02172029184728079, 0.005245127281285728, 0.000358849069115854, 0.0007128072449613401, -0.005365694500073004, -0.006243272708723153, 0.005345636094320155, 0.0046112005660993265, -0.0008215637197951792, 0.021264707391046116, 0.00615520292678176, 0.010252380715014447, 0.024513690807038847, 0.01934252326550463, 0.01017714521713454, 0.01362457758512602, 0.01954487311510029, -0.008089895136031451, 0.00529902220884525, 0.009162730278911749, 0.0026332776032047017, 0.003667953410793417, 0.004020126752344902, -0.003417857956889205, -0.002160953798631242, -0.03107805756948091, 0.003741610433540793, 0.022806723629580562, -0.002356533276227462, -0.010398465216679862, -0.004693898112578459, 0.004255624391314414, -0.00042013695450625164, 0.0003779785190776598, 0.015206700339666694, -0.001018934677286277, -0.006528543701850333, 0.013205871827816264, 0.001530668557096558, 0.0008273322353406354, 0.011512299882111695, -0.004228650834572537, -0.02433317335726992, 0.01370221969925153, 0.00821403954080629, -0.0009457478742706581, 0.01341539241423802, -0.013504017795994624, 0.020974811182503984, 0.004577288678945622, 0.006418225640652833, -0.003290572793613752, 0.01999717615322213, -0.007577831156112931, 0.013298580933904704, 0.0007525167367178278, -0.004652770055196557, 0.011777524198609914, -0.0017069910070710856, -0.0050721449555600935, 0.001279295635473729, 0.017434324319609357, 0.007341599762468814, 0.01740751362535128, 0.009002769374394416, 0.004817422895022833, 0.01416330759680839, -0.01104453610698833, 0.0058153262335412905, -0.017178706452135515, 0.010330371509248967, 0.013053316951791844, 0.0028816698882948334, 0.0035678149166711894, 0.0034475579762234636, -0.012971914670698342, 0.010856077869636424, 0.009290029110924879, 0.008073345992037236, -0.0062961934650808925, 0.0048639110153310084, 0.009663557484163502, 0.015842584949906403, 0.007144837863680214], "E_coli":[0.023059443490370722, 0.018697598087245224, 0.020662100576726506, 0.02118217656120133, 0.02179920340848565, 0.021984761058347263, 0.02577122965659471, 0.026290906458505407, 0.02587854788872995, 0.020726745990609613, 0.02465808520448252, 0.02345574574469937, 0.024145063754959985, 0.023808544657875696, 0.02324253396340712, 0.023542354420829567, 0.020749921501789625, 0.020643281733376664, 0.020468198898612826, 0.02572220305823113, 0.02259212265009239, 0.023615159779414675, 0.020154776337317038, 0.02290629725624899, 0.02538982330100481, 0.023858944679675816, 0.021739183218034204, 0.02574139099571931, 0.02460927713585987, 0.024836598515580777, 0.02396145081624206, 0.022667781289928014, 0.022969625346987956, 0.024784607933009656, 0.019517833995235444, 0.021921024467808473, 0.0200921466413733, 0.025367561897119882, 0.025971616076067655, 0.01855741639509183, 0.019634650060648354, 0.018962669488543926, 0.01902425126227211, 0.02523199356995576, 0.021948411007036987, 0.02113072608421178, 0.02196337595622818, 0.02473204653765774, 0.0246962480806082, 0.02590595838509111, 0.020183318552079152, 0.025108079221853048, 0.0219029086083629, 0.020212582550314374, 0.02167160795637487, 0.022163485630699364, 0.022826277914835408, 0.02466372475526947, 0.024570120527566398, 0.023145829385362852, 0.021279674817528266, 0.02507076133950454, 0.023899577731475635, 0.022547034506889635, 0.01836262571165392, 0.024117127868881233, 0.021637128877829818, 0.02485722352718505, 0.01853093219556969, 0.020392408050951927, 0.021214040102887584, 0.024044164168692535, 0.02009117696949422, 0.023454160391959324, 0.023934213191653814, 0.02408918530709528, 0.017536614910234755, 0.02068144975706126, 0.02207599632483637, 0.025038095196848187, 0.020687892992366615, 0.022126444199424965, 0.02417403184057096, 0.026942294338368408, 0.025610125642740674, 0.02078425322683806, 0.025680778961545813, 0.019894670061651798, 0.023240392230874155, 0.02701771812412117, 0.0265124356689517, 0.018677251905375353, 0.025589144563528596, 0.023066618689566408, 0.023133676082429153, 0.021432108205786112, 0.027737852886566404, 0.021968328079781066, 0.021647271781386875, 0.025231553949267953], "P_aeruginosa":[0.022155593873304916, 0.015397645226856159, 0.011134105176459954, -0.0015688247522675969, 0.0029879944727636103, 0.003135985298026331, 0.004688424051171469, -0.011785906501263712, 0.024220880281849683]}
Species = ["B_subtilis", "M_tuberculosis", "S_coelicolor", "E_coli", "P_aeruginosa"]

#Create a dictionary of dictionaries with the mean and standard deviations of a population of correlations from random modules
dic_mean_std = {}
for specie in Species:
  CorrectedCorrs= []
  Statistics = []
  for corr in GenModCorrRand.get(specie):
    CorrectedCorrs.append(corr/GenOpCor.get(specie)[0])
  Statistics.append(np.mean(CorrectedCorrs))
  Statistics.append(np.std(CorrectedCorrs))
  dic_mean_std[specie] = Statistics

#abs_value_corr_dep.txt has the results of the gene-module correlations in the following way: {'organism': {'method':{module:[value of relative correlation, number of genes in the module],...},...},...}
with open('abs_value_corr_dep.txt', 'r') as file:
    tmp=re.sub('masked', '\'masked\'', file.read())
    tmp=re.sub('nan', 'None', tmp)
    dic= ast.literal_eval(tmp)

#new_dic store the results of the gene-module correlations in the following way: {'organism':{'association':[list with gene-module correlations for that organism],...},...}
new_dic={}
for organismo in dic.keys():
  dic_org=dic.get(organismo)
  tmp_dic={}
  for metodo in dic_org.keys():
    dic_met=dic_org.get(metodo)
    merge = list(itertools.chain.from_iterable(dic_met.values()))
    all_corr=[y for x,y in enumerate(merge) if x%2 == 0]
    tmp_dic[metodo] = all_corr
  new_dic[organismo] = tmp_dic

#Create a dictionary of dictionaries per organism and per method to store the Z-scores of gene-module correlations
Z_scores_dic={}
for organismo in new_dic.keys():
  Z_scores= []
  dic_org=new_dic.get(organismo)
  tmp_dic={}

  for metodo in dic_org.keys():
    tmp_corr_met=dic_org.get(metodo)
    Z_scores = [(x-dic_mean_std.get(organismo)[0])/dic_mean_std.get(organismo)[1] for x in tmp_corr_met]
    tmp_dic[metodo] = Z_scores
  Z_scores_dic[organismo] = tmp_dic
